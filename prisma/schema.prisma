// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String
  name     String
  role     String // "TEACHER" or "STUDENT"

  // For student accounts - reference to their teacher
  teacherId String?
  teacher   User?   @relation("TeacherStudents", fields: [teacherId], references: [id], onDelete: Cascade)

  // For teacher accounts - list of their students
  students User[] @relation("TeacherStudents")

  // Invitation token for students (used when teacher invites)
  inviteToken     String?   @unique
  inviteExpiresAt DateTime?

  // Practice sessions (only for students) - legacy
  practiceSessions LegacyPracticeSession[] @relation("LegacyStudentSessions")

  // New nested practice sessions
  practiceSessionsNew PracticeSession[] @relation("StudentSessions")

  // Pieces (only for students)
  pieces Piece[] @relation("StudentPieces")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([inviteToken])
}

// Legacy model - will be migrated to new structure
model LegacyPracticeSession {
  id                   String                  @id @default(cuid())
  studentId            String
  student              User                    @relation("LegacyStudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  title                String
  description          String?
  duration             Int
  audioFilePath        String
  audioFileSize        Int?
  status               String                  @default("COMPLETED")
  teacherFeedback      String?
  teacherFeedbackAudio String?
  teacherFeedbackAt    DateTime?
  analysis             LegacyPracticeAnalysis?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt

  @@index([studentId])
  @@index([createdAt])
}

// New nested practice session structure
model PracticeSession {
  id            String            @id @default(cuid())
  studentId     String
  student       User              @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  date          DateTime          @default(now())
  totalDuration Int               @default(0) // in seconds
  status        SessionStatus     @default(ACTIVE) // ACTIVE or COMPLETED
  segments      PracticeSegment[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([studentId])
  @@index([createdAt])
}

model PracticeSegment {
  id                   String            @id @default(cuid())
  sessionId            String
  session              PracticeSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  pieceId              String?
  piece                Piece?            @relation(fields: [pieceId], references: [id], onDelete: SetNull)
  title                String
  type                 SegmentType       @default(PIECE) // PIECE, WARMUP, TECHNIQUE, SIGHTREADING, OTHER
  notes                String?
  audioUrl             String
  duration             Int // in seconds
  metronomeBPM         Int?
  referenceVideoUrl    String?
  recordedAt           DateTime          @default(now())
  analysis             PracticeAnalysis?
  teacherFeedbackText  String?
  teacherFeedbackAudio String?
  teacherFeedbackAt    DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  @@index([sessionId])
  @@index([pieceId])
}

model Piece {
  id                       String            @id @default(cuid())
  name                     String
  composer                 String?
  studentId                String
  student                  User              @relation("StudentPieces", fields: [studentId], references: [id], onDelete: Cascade)
  difficulty               String?
  dateStarted              DateTime          @default(now())
  status                   PieceStatus       @default(LEARNING) // LEARNING, PRACTICING, PERFORMANCE_READY, MASTERED
  targetBPM                Int?
  defaultReferenceVideoUrl String?
  notes                    String?
  segments                 PracticeSegment[]
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt

  @@index([studentId])
}

enum SessionStatus {
  ACTIVE
  COMPLETED
}

enum SegmentType {
  PIECE
  WARMUP
  TECHNIQUE
  SIGHTREADING
  OTHER
}

enum PieceStatus {
  LEARNING
  PRACTICING
  PERFORMANCE_READY
  MASTERED
}

// Legacy analysis model
model LegacyPracticeAnalysis {
  id                  String                @id @default(cuid())
  sessionId           String                @unique
  session             LegacyPracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  overallFeedback     String
  piecesIdentified    String?
  timeBreakdown       String?
  suggestions         String?
  strengths           String?
  areasForImprovement String?
  overallScore        Int?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  @@index([sessionId])
}

// New analysis model - links to segment
model PracticeAnalysis {
  id                  String          @id @default(cuid())
  segmentId           String          @unique
  segment             PracticeSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  overallFeedback     String
  piecesIdentified    String?
  timeBreakdown       String?
  suggestions         String?
  strengths           String?
  areasForImprovement String?
  overallScore        Int?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([segmentId])
}
