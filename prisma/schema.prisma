// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   // "TEACHER" or "STUDENT"

  // For student accounts - reference to their teacher
  teacherId String?
  teacher   User?    @relation("TeacherStudents", fields: [teacherId], references: [id], onDelete: Cascade)

  // For teacher accounts - list of their students
  students  User[]   @relation("TeacherStudents")

  // Invitation token for students (used when teacher invites)
  inviteToken     String?   @unique
  inviteExpiresAt DateTime?

  // Practice sessions (only for students)
  practiceSessions PracticeSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([inviteToken])
}

model PracticeSession {
  id            String        @id @default(cuid())

  // Student who recorded this session
  studentId     String
  student       User          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Session metadata
  title         String
  description   String?
  duration      Int           // Duration in seconds
  audioFilePath String        // Path to stored audio file
  audioFileSize Int?          // File size in bytes
  status        String        @default("COMPLETED") // "RECORDING", "COMPLETED", or "ANALYZED"

  // Analysis results
  analysis      PracticeAnalysis?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([studentId])
  @@index([createdAt])
}

model PracticeAnalysis {
  id        String   @id @default(cuid())

  // Associated practice session
  sessionId String          @unique
  session   PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // AI Analysis Results
  overallFeedback String        // General feedback from Claude

  // Identified pieces/exercises (stored as JSON string)
  // Example: [{"name": "Bach Prelude", "duration": 300, "timeSpent": "5:00"}]
  piecesIdentified String?

  // Time breakdown (stored as JSON string)
  // Example: {"warmup": 300, "technique": 600, "repertoire": 900}
  timeBreakdown String?

  // Specific suggestions (stored as JSON string)
  // Example: [{"timestamp": "2:30", "issue": "Timing inconsistency", "suggestion": "Use metronome"}]
  suggestions String?

  // Strengths identified (stored as JSON string)
  strengths String?

  // Areas for improvement (stored as JSON string)
  areasForImprovement String?

  // Overall score (1-10)
  overallScore Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
}
